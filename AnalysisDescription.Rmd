---
title: "Tapirus - Cerrado"
author: "Tati Micheletti"
date: "21 January 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
library(rdrop2)
 drop_auth()
 token <- drop_auth()
 saveRDS(token, file = "token.rds")
```

# Project Description

The present project aimed at ...

# Hematology and Biochemestry

## Analysis summary

The following analysis were performed for the results to be comparable to the `"Health Assessment of Wild Lowland Tapirs"` *[Journal of Wildlife Disease, 2014]*.

1. Shapiro-Wilk to test Normality of Samples
  + 1a. Non-normal try transform [log(e)] --> test SW again
    -  1a1. Non-normal again --> NON PARAMETRIC
  + 1b. Normal, pass to 2.
2. Levene's test of Variance homogeneity
  + 2a. Non-homogeneous try transform [log(e)] --> test Levene again
    -  2a1. Non-homogeneous --> NON PARAMETRIC
  + 2b. Normal, use --> PARAMETRIC

FOR NON-PARAMETRIC SAMPLES: `Kruskal-Wallis` test for more than 2 classes or `Mann-Whitney U` test for 2 classes
FOR PARAMETRIC SAMPLES: `ANOVA` for more than 2 classes or `T-TEST` for 2 classes

The groups were hierarchically designed as: Biome > Sex > Age. I.e. Pantanal Males Juv x Pantanal Males Adults and only the variables that were *not signifficant* for each group were compared on the next level.

## Coding

### 1. Load Data

Loading the data to work with from a `.csv` file.
```{r load}
hembio <- drop_read_csv("dataTapirus/hematobioqFull.csv", dtoken = token) #If it doesn't work, turn on the VPN
#hembio <- test[ , order(names(test))] # Don't remember why this... =/
```
**SIDENOTE: If the dataloading fails, turn on the VPN!.**

Here is the final complete table for biochemestry and hemathology (Mata Atlantica, Pantanal and Cerrado):
```{r Table HEMBIO, eval=TRUE, echo=FALSE}
knitr::kable(as.data.table(hembio))
```

### 2. Shapiro-Wilk test

This test was performed to observe if the samples have a relatively normal distribution. Each answer was stored on a table:
```{r shapiro-test}
fDataCol <- 5 #First data column
sw.test <- list()
for (i in fDataCol:ncol(hembio)){
sw.test[[i]] <- shapiro.test(hembio[,i])
sw.test[[i]] <- sw.test[[i]]$p.value}

Variables <- colnames(hembio[,fDataCol:ncol(hembio)])
sw.pvalue <- as.numeric(unlist(sw.test))
sw.results <- data.frame(Variables, sw.pvalue)
sw.results$Normality <- NA
sw.results <- as.data.table(sw.results)
for (i in 1:nrow(sw.results)){
   if (sw.results$sw.pvalue[i]>0.05){
       sw.results$Normality[i] <- "NORMAL" }}
```

Variables that have a normal distribution are marked as `NORMAL` in the `Normality` column.

```{r primary results shapiro, echo=FALSE, eval=TRUE}
knitr::kable(sw.results)
nat.normal <- as.character(sw.results$Variables[!is.na(sw.results$Normality)])
```

Now, variables that are not normal (described as `NA` in the `Normality` column) have to be log(e) - natural logarithm - transforemed and tested again:

```{r variables transformation}
var.transform <- as.character(sw.results$Variables[is.na(sw.results$Normality)])
hembio.log <- cbind(hembio[,c("ID","Biome","Sex","Age")],log(hembio[,var.transform]))
```

```{r variables transformed, echo=FALSE, eval=TRUE}
knitr::kable(as.data.table(hembio.log))
```

Now we apply again the Shapiro-Wilk test on the transformed variables and see if any of them can be used:
```{r shapiro-test2}
sw.test2 <- list()
for (i in fDataCol:ncol(hembio.log)){
sw.test2[[i]] <- shapiro.test(hembio.log[,i])
sw.test2[[i]] <- sw.test2[[i]]$p.value}

Variables <- colnames(hembio.log[,fDataCol:ncol(hembio.log)])
sw.pvalue <- as.numeric(unlist(sw.test2))
sw.results2 <- data.frame(Variables, sw.pvalue)
sw.results2$Normality <- NA
sw.results2 <- as.data.table(sw.results2)
for (i in 1:nrow(sw.results2)){
   if (is.finite(sw.results2$sw.pvalue[i])&sw.results2$sw.pvalue[i]>0.05){
       sw.results2$Normality[i] <- "NORMAL" }}
```

Variables that presented a normal distribution after transformation are marked as `NORMAL` in the `Normality` column.

```{r secondary results shapiro, echo=FALSE, eval=TRUE}
knitr::kable(sw.results2)
non.normal <- as.character(sw.results2$Variables[is.na(sw.results2$Normality)])
normal.trans <- as.character(sw.results2$Variables[!is.na(sw.results2$Normality)])
```

List of variables that will naturally be treated as `NON-NORMAL`, and therefore will be analyzed with `NON-PARAMETRIC` tests:
```{r non parametric, echo=FALSE, eval=TRUE}
sw.results2$Normality[is.na(sw.results2$Normality)] <- "NON-NORMAL"
knitr::kable(sw.results2[sw.results2$Normality=="NON-NORMAL"])
```
**NOTE: It is important to not that more variables will be added to this list after the homogeneity test.**  

### 3. Levene's test

After the normality test, the Levene's test for homogeneity of variance across groups needs to be performed on the following variables: 
```{r homogen, echo=FALSE, eval=TRUE}
library(car)
normal <- c(nat.normal, normal.trans)
hembio.homog <- cbind(hembio[,1:(fDataCol-1)],hembio[normal])
knitr::kable(as.data.table(hembio.homog))
homo.test <- colnames(hembio.homog[5:ncol(hembio.homog)])
```

This test was performed to observe if the samples present a homogeneity of variances. Each answer was stored on a table:
```{r levene}
source(file.path(getwd(),"R functions/Levene.R"))

  pant.m <- hembio.homog[hembio.homog$Biome=="Pantanal"&hembio.homog$Sex=="Male",]
  pant.f <- hembio.homog[hembio.homog$Biome=="Pantanal"&hembio.homog$Sex=="Female",]
  atl <- hembio.homog[hembio.homog$Biome=="Atlantic",] #Can't be performed at Age level because have only one juvenile, performed at Sex level
  cerr.m <- hembio.homog[hembio.homog$Biome=="Cerrado"&hembio.homog$Sex=="Male",]
  cerr.f <- hembio.homog[hembio.homog$Biome=="Cerrado"&hembio.homog$Sex=="Female",]

lv.pant.m <- levene.p(pant.m,fDataCol, "Age")
lv.pant.f <- levene.p(pant.f,fDataCol, "Age")
lv.atl <- levene.p(atl,fDataCol, "Sex") 
lv.cerr.m <- levene.p(cerr.m,fDataCol, "Age")
lv.cerr.f <- levene.p(cerr.f,fDataCol, "Age")
```

```{r homogen final tables, echo=FALSE, eval=TRUE}
knitr::kable(lv.pant.m)
knitr::kable(lv.pant.f)
knitr::kable(lv.atl)
knitr::kable(lv.cerr.m)
knitr::kable(lv.cerr.f)
```

The following variables were not homogeneous for the following groups:
PANTANAL: MALES: `Plaquetas`, `LeucocitosTotais` and `LactatoDesigrogenase`
PANTANAL: FEMALES: `ColesterolFracionadoHDL` and `LactatoDesigrogenase`
ATLANTIC: BOTH SEXES: `ColesterolFracionadoLDL`,  `ColesterolFracionadoVLDL` and `LactatoDesigrogenase`
CERRADO: MALES: `Hemoglobina` and `Plaquetas`
CERRADO: FEMALES: `Hemoglobina`, `Plaquetas` and `ColesterolFracionadoVLDL`

```{r vector non homogenous}
non.homo <- c("Plaquetas", "LeucocitosTotais", "LactatoDesigrogenase", "ColesterolFracionadoHDL", "ColesterolFracionadoLDL", "ColesterolFracionadoVLDL", "Hemoglobina", "Plaquetas")
```

Therefore, these will be tested using `NON-PARAMETRIC` statistics, since at least in one group these are not homogenous.

Now it is necessary to check which variables have enough samples (>2 for biome and sex, >3 for ages) to perform a comparative mean test. First, we count how many values different than `NA` we have for each variable in each group:

```{r testing, echo=FALSE, eval=TRUE}
library(dplyr)
library(reshape2)
hembio.dt <- as.data.table(hembio[,!colnames(hembio)=="ID"])
binary.dt <- as.data.frame(hembio.dt)

# Converting the table to binary (o/1) so I know which variables 
# don't have enough data to compare
for (i in 1:nrow(binary.dt)){
  for (j in 4:ncol(binary.dt)){
    if (!is.na(binary.dt[i,j]))
        binary.dt[i,j] <- 1
  }
}
binary.dt$BSA <- paste(binary.dt$Biome, binary.dt$Sex, binary.dt$Age, sep = ":")
binary.dt <- binary.dt[,4:ncol(binary.dt)]
count.df <- binary.dt %>% 
  melt(id.var="BSA") %>%
  filter(!is.na(value)) %>%  # Remove NA
  group_by(BSA, variable, value) %>%
  summarise(count=n()) %>% 
  group_by(BSA, variable)
count.df <- as.data.frame(count.df)
count.df <- tidyr::separate(data = count.df, col = BSA, sep = ":", into = c("Biome","Sex","Age"))
count.df <- as.data.table(count.df)
#two_cat <- count.df[count.df$count==1]
```

```{r count.df, echo=TRUE, eval=TRUE}
knitr::kable(count.df)
```

Now we subset this table per Biome and Sex, to observe the variables for each age and for sex:
```{r subset, echo=FALSE, eval=TRUE}

At.F <- count.df[Biome=="Atlantic"&Sex=="Female"]
At.M <- count.df[Biome=="Atlantic"&Sex=="Male"]
Pt.F <- count.df[Biome=="Pantanal"&Sex=="Female"]
Pt.M <- count.df[Biome=="Pantanal"&Sex=="Male"]
Cr.F <- count.df[Biome=="Cerrado"&Sex=="Female"]
Cr.M <- count.df[Biome=="Cerrado"&Sex=="Male"]

At <- count.df[Biome=="Atlantic"]
Pt <- count.df[Biome=="Pantanal"]
Cr <- count.df[Biome=="Cerrado"]
```

For each variable in the table, check if there are at least 2 Age groups to compare
```{r compare.counts, echo=FALSE, eval=TRUE}
# ATLANTIC FOREST
atF.J <- At.F[Age=="Juvenile", sum(count>1)]
atF.Sa <- At.F[Age=="Sub-adult", sum(count>1)]
atF.Ad <- At.F[Age=="Adult", sum(count>1)] # No variables can be compared among female groups

atM.J <- At.M[Age=="Juvenile", sum(count>1)]
atM.Sa <- At.M[Age=="Sub-adult", sum(count>1)]
atM.Ad <- At.M[Age=="Adult", sum(count>1)]
At.M[Age=="Sub-adult"&count>1] # Which variables can be compared between Sub-adult and Adult males from Atlantic forest

# PANTANAL
ptF.J <- Pt.F[Age=="Juvenile", sum(count>1)]
ptF.Sa <- Pt.F[Age=="Sub-adult", sum(count>1)]
ptF.Ad <- Pt.F[Age=="Adult", sum(count>1)] # No variables can be compared among female groups

ptM.J <- Pt.M[Age=="Juvenile", sum(count>1)]
ptM.Sa <- Pt.M[Age=="Sub-adult", sum(count>1)]
ptM.Ad <- Pt.M[Age=="Adult", sum(count>1)]
```

### Atlantic Forest
Female groups of Atlantic Forest:
```{r compare groups, echo=TRUE, eval=TRUE}
atF.Ad # Atlantic Forest Adult Females
atF.Sa # Atlantic Forest Sub-adult Females
atF.J # Atlantic Forest Juvenile Females
```
** Conclusion:** No comparison can be made by age among females from Atlantic forest due to the lack of data

Male groups of Atlantic Forest:
```{r compare groups, echo=TRUE, eval=TRUE}
atM.Ad # Atlantic Forest Adult Females
atM.Sa # Atlantic Forest Sub-adult Females
atM.J # Atlantic Forest Juvenile Females
At.M[count>1&variable=="Ureia"|
     count>1&variable=="ColesterolTotal"|
     count>1&variable=="ProteinasTotais"]
```
** Conclusion:** Comparison among males from Atlantic forest can be made only for: `Ureia`, `ColesterolTotal` and `ProteinasTotais` for Adults and Sub-Adults.

### Pantanal
Female groups of Pantanal:
```{r compare groups, echo=TRUE, eval=TRUE}
ptF.Ad # Pantanal Adult Females
ptF.Sa # Pantanal Sub-adult Females
ptF.J # Pantanal Juvenile Females
```
** Conclusion:** Comparison among Adults and Sub-adults can be made for the following 41 variables:
```{r var.pant.fem, echo=FALSE, eval=TRUE}
Pt.SubA <- Pt.F[Age=="Sub-adult"]$variable
Pt.Adu <- Pt.F[Age=="Adult"]$variable
Pt.SubA %in% Pt.Adu #Are all variables the same between adults and sub-adults?
knitr::kable(Pt.Adu)
```

Male groups of Pantanal:
```{r compare groups, echo=TRUE, eval=TRUE}
ptM.Ad # Pantanal Adult Females
ptM.Sa # Pantanal Sub-adult Females
ptM.J # Pantanal Juvenile Females
```
** Conclusion:** Comparison among males from Pantanal can be made for the following variables based on `Adults`:
```{r compare male groups, echo=FALSE, eval=TRUE}
Pt.MSubA <- Pt.M[Age=="Sub-adult"]$variable
Pt.MAdu <- Pt.M[Age=="Adult"]$variable
Pt.MJuv <- Pt.M[Age=="Juvenile"&count>1]$variable
Pt.MSubA %in% Pt.MAdu #Are all variables the same between adults and sub-adults?
Pt.MAdu %in% Pt.MJuv #Are all variables the same between adults and sub-adults?
knitr::kable(data.frame(Variables=Pt.MAdu,SubAdults=(Pt.MSubA %in% Pt.MAdu),Juvenile=(Pt.MAdu %in% Pt.MJuv)))
```

### Cerrado

`DO THE SAME FOR CERRADO. THEN CREATE A SPECIFIC TABLE FOR THE TESTS TO BE MADE AND FOR WHICH AGE CLASSES THESE COMPARISONS CAN BE MADE? like a column with`
COMPARISON
Ad x Sub-A
Ad x Juv
`etc.? Think of how to do this in one table for all the three levels.` 

variables <- as.character(colnames(hembio.dt))

The following table presents a summary of the analysis to be performed for each variable:
```{r final.table, echo=FALSE, eval=TRUE}
test_groups <- data.table(PARAM = rep(c("PARAMETRIC", "NON-PARAMETRIC"), each = 2), GROUP = c(2,3,2,3), TEST = c("T-Test", "ANOVA", "Mann-WhitneyU","Kruskal-Wallis"))
all.var <- colnames(hembio[,c(fDataCol:ncol(hembio))])
final.table <- data.frame(VARIABLES = all.var, NORMALITY = NA, TRANSFORMATION = NA, HOMOGENEITY = NA, TEST = NA, BIOME_GROUPS = NA, SEX_GROUPS = NA, AGE_GROUPS = NA)
for (i in 1:nrow(final.table)){
  if (final.table[i,"VARIABLES"] %in% nat.normal)
          final.table[i,"NORMALITY"] <- "NORMAL" else 
          final.table[i,"NORMALITY"] <- "NON-NORMAL"
  if (final.table[i,"VARIABLES"] %in% normal.trans) 
          final.table[i,"TRANSFORMATION"] <- "NORMAL" else
      if (final.table[i,"NORMALITY"]=="NORMAL") 
              final.table[i,"TRANSFORMATION"] <- "NA" else
              final.table[i,"TRANSFORMATION"] <- "NON-NORMAL"
  if (!(final.table[i,"VARIABLES"] %in% homo.test))
          final.table[i,"HOMOGENEITY"]  <- "NA" else
      if (final.table[i,"VARIABLES"] %in% non.homo) 
              final.table[i,"HOMOGENEITY"] <- "NON-HOMOGENEOUS" else 
              final.table[i,"HOMOGENEITY"] <- "HOMOGENEOUS"
  if (!(final.table[i,"TRANSFORMATION"] == "NON-NORMAL") & final.table[i,"HOMOGENEITY"] == "HOMOGENEOUS")
              final.table[i,"TEST"] <- "PARAMETRIC" else
              final.table[i,"TEST"] <- "NON-PARAMETRIC"
}
```


check exactly which test will be performed, so I can built up a function using this table!
 Now I need to construct columns for "BIOME", "SEX" and "AGE", checking how many NON-NA values I have for each cathegory of these for each variable. Use data.table for the counts on the original table, extract the values to "memory" and based on that, chose between the parametric or non (using the TEST column)  ==> use table sum_groups to start extracting info...   


` MAKE A FINAL TABLE HERE WITH NORMALITY AND HOMOGENEITY FOR EACH VARIABLE AND THE RESPECTIVE TESTS TO BE APPLIED AND AT WHICH VARIABLES (BIOME, SEX, AGE or just BIOME, SEX) or a column that shows KW or TEST T FOR EACH ONE AT EACH LEVEL? Think this through...`

Write NORMAL or NON-NORMAL. Do the same for Levene "HOMOGENEOUS" - "NON-HOMOG". The variables that are NORMAL & HOMOGENEOUS, use parametric, the others non parametric, group by variables in col 2:4.



