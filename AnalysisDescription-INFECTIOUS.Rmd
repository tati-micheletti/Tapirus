---
title: "Tapirus terrestris: Health analysis - INFECTIOUS DISEASES"
author: "Tati Micheletti"
date: "16 May 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
library(reproducible)
library(rdrop2)
library(stats)
 token <- drop_auth()
```


# Project Description

The present project aimed at understanding the general health of Tapir (**Tapirus terrestris**) populations on three different biomes.

# Diseases

## Analysis summary
diseases: only prevalence (X2)

1. Prevalences --> % positives on the population (relative prevalence). Use the positives in the total tested. (For each disease, positives/total ind. tested) Ex. 
A - disease1, disease2
B - Negative
C - disease1
D - disease1
E - Negative

Prevalence disease1: 3/5 = 0.6 or 60%
Prevalence disease2: 1/5 = 0.2 or 20%

To calculate the standard error of the binomial distribution, we have:

SE = sqrt(pH*(1-pH)/(n+1)), where pH = (x+1/2)/(n+1), `x` is the number of "positives" and `n` is the total number of samples 

## Coding

Loading the data to work with from a `.csv` file and subsetting to diseases that have both positive and negative results.
```{r load}
infectiousFull <- data.table::fread("C:/Users/Tati/Dropbox/dataTapirus/diseasesPrev.csv") # loading from the local computer
for (i in names(infectiousFull)) infectiousFull[get(i)=="", (i) := NA]
cols <- colnames(infectiousFull)
colsToKeep <- unlist(lapply(X = cols, FUN = function(columns){
  if ("Negativo" %in% infectiousFull[[columns]] &
      "REAGENTE" %in% infectiousFull[[columns]])
    return(TRUE) else return(FALSE)
})
)
infectiousFull <- infectiousFull[, colsToKeep, with = FALSE]
infectiousFull
```

Now we need to calculate frequencies of positives:

```{r calculate_fre}
cols <- colnames(infectiousFull)
counts <- data.table::rbindlist(lapply(X = names(infectiousFull), FUN = function(x){
  tble <- as.data.frame(table(infectiousFull[[x]]), responseName = "freq")
  colnames(tble)[1] <- "result"
  tble$disease <- x
  return(tble)
})
)
``` 

And at last, we have to calculate the estimate (prevalence) and respective confidence intervals:
``` {r ci}
CI <- data.table::rbindlist(lapply(X = cols, FUN = function(dis){
  sb <- counts[disease == dis,]
  total <- sum(sb$freq)
  positive <- sb[result == "REAGENTE", freq]
  CI.calc <- stats::binom.test(x = positive, n = total, p = 0.5,
                                   alternative="two.sided",
                                   conf.level=0.95)
  CI.low <- min(CI.calc$conf.int)
  CI.up <- max(CI.calc$conf.int)
  Ci <- data.table::data.table(disease = dis,
                               prevalence = round(CI.calc$estimate, 3)*100,
                               CI = paste0(round(CI.low, 3)*100, " - ", round(CI.up, 3)*100))
  return(Ci)
})
)

CI

```

